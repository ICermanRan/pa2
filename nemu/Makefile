# Sanity check
#通过 wildcard 命令查找 $(NEMU_HOME)/src/nemu-main.c 文件是否存在，
#如果不存在，则通过 error 命令打印错误信息。
ifeq ($(wildcard $(NEMU_HOME)/src/nemu-main.c),)
  $(error NEMU_HOME=$(NEMU_HOME) is not a NEMU repo)
endif

# Include variables and rules generated by menuconfig
# 这两行代码用于引入 menuconfig 生成的配置变量和规则。
-include $(NEMU_HOME)/include/config/auto.conf
-include $(NEMU_HOME)/include/config/auto.conf.cmd

remove_quote = $(patsubst "%",%,$(1))

# Extract variabls from menuconfig
#remove_quote 函数用于去除可能存在的引号。
#然后，NAME 变量被设置为 GUEST_ISA 和 ENGINE 的组合，中间用短横线连接。

#?= 运算符用于为变量设置默认值。在这种情况下，如果 GUEST_ISA 和 ENGINE 变量尚未设置，
#它们将被设置为 CONFIG_ISA 和 CONFIG_ENGINE 变量的值，而不是保留原来的值。
#如果 GUEST_ISA 和 ENGINE 变量已经设置，则它们的值不会更改。

GUEST_ISA ?= $(call remove_quote,$(CONFIG_ISA))
ENGINE ?= $(call remove_quote,$(CONFIG_ENGINE))
NAME    = $(GUEST_ISA)-nemu-$(ENGINE)



# Include all filelist.mk to merge file lists

#首先，查找所有名为 filelist.mk 的文件，并将它们包含到当前文件中。
#filelist.mk 文件中包含了一些变量，用于指定要编译的源文件。
FILELIST_MK = $(shell find ./src -name "filelist.mk")
include $(FILELIST_MK)

# Filter out directories and files in blacklist to obtain the final set of source files
#然后，定义一些黑名单变量，用于指定不需要编译的目录和文件。
#它会先找出所有在黑名单中的目录，并将所有在这些目录中的 .c 文件都加入黑名单。
DIRS-BLACKLIST-y += $(DIRS-BLACKLIST)
SRCS-BLACKLIST-y += $(SRCS-BLACKLIST) $(shell find $(DIRS-BLACKLIST-y) -name "*.c")
#最后，它会找出所有需要编译的目录，并从中提取所有 .c 文件，
#最终将它们筛送出黑名单中的文件，得到最终的源文件列表。
SRCS-y += $(shell find $(DIRS-y) -name "*.c") #将shell命令的运行结果赋值给变量
SRCS = $(filter-out $(SRCS-BLACKLIST-y),$(SRCS-y))

#筛选文件列表的过程使用了 filter-out 函数。这个函数会将第二个参数中不在第一个参数中出现过的项目返回。


# Extract compiler and options from menuconfig
#这段代码用于从菜单配置中提取编译器和选项，并设置相应的编译器变量
#首先设置 CC 变量为 CONFIG_CC 的值，并使用 remove_quote 函数去除可能存在的引号。
#然后，它检查了菜单配置中的各种选项，并根据它们来设置 CFLAGS_BUILD 和 CFLAGS_TRACE 变量
#最后，它将这些变量用于设置 CFLAGS 和 LDFLAGS 变量，以便在编译时使用它们。这些变量包含了编译器和选项，用于编译程序。
CC = $(call remove_quote,$(CONFIG_CC))
CFLAGS_BUILD += $(call remove_quote,$(CONFIG_CC_OPT))
CFLAGS_BUILD += $(if $(CONFIG_CC_LTO),-flto,)
CFLAGS_BUILD += $(if $(CONFIG_CC_DEBUG),-Og -ggdb3,)
CFLAGS_BUILD += $(if $(CONFIG_CC_ASAN),-fsanitize=address,)
CFLAGS_TRACE += -DITRACE_COND=$(if $(CONFIG_ITRACE_COND),$(call remove_quote,$(CONFIG_ITRACE_COND)),true)
CFLAGS  += $(CFLAGS_BUILD) $(CFLAGS_TRACE) -D__GUEST_ISA__=$(GUEST_ISA)
LDFLAGS += $(CFLAGS_BUILD)

# Include rules for menuconfig
#这段代码包括了其他 Makefile 中的规则，用于构建 NEMU 程序

#include $(NEMU_HOME)/scripts/config.mk 语句包括了
#config.mk Makefile 中的规则，用于处理菜单配置选项。
include $(NEMU_HOME)/scripts/config.mk

#ifdef 语句检查 CONFIG_TARGET_AM 变量是否已定义。
ifdef CONFIG_TARGET_AM

#如果定义了，则执行 include $(AM_HOME)/Makefile 语句，
#它包括了 AM_HOME 目录中的 Makefile 中的规则
#然后将 LINKAGE 变量附加上 ARCHIVES 变量。
include $(AM_HOME)/Makefile
LINKAGE += $(ARCHIVES)

#如果 CONFIG_TARGET_AM 未定义，则执行 include $(NEMU_HOME)/scripts/native.mk 语句
else
#它包括了 native.mk Makefile 中的规则，用于构建 NEMU 程序。
#这些规则用于编译程序并链接所有必要的对象文件，以创建最终的可执行文件
# Include rules to build NEMU
include $(NEMU_HOME)/scripts/native.mk
endif
